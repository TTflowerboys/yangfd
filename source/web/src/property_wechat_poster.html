<!--@@master = masters/wechat_poster_master.html-->

<!--@@block =head -->

<!-- cause video-js.css has related path font resource, so package in the same dir-->
<!--build:css(dist) /static/bower_components/video-js/dist/video-js/video-js.css-->
<link rel="stylesheet" href="/static/bower_components/video-js/dist/video-js/video-js.css">
<!--endbuild-->

<!--build:css(dist) /static/styles/property_wechat_poster.html.css-->
<link rel="stylesheet" href="/static/styles/phone/propertyWechatPoster.css">
<!--endbuild-->
<!--@@close-->

<!--@@block =main -->
<script type="text/javascript">
    window.viewStartTime = new Date()
    window.durationArray = []
    window.isInit = false
    var process = new Process({
        canvasId: 'procanvas',
        textId: 'proText',
        outerWidth: '100',
        innerWidth: '94',
        backColor: '#333',
        underColor: '#474747',
        activeColor: '#46dcfd'
    })
    process.moveTo(75, 1000, function(){
        process.moveTo(90, 5000, function(){
            process.moveTo(95, 5000, function() {
                $(window).trigger('ownLoadEvent')
            })
        })
    })
</script>
<div class="swiper-container mainSwiper" style="">
    <div class="swiper-wrapper" style="">
        <div class="swiper-slide swiper-slide-bg commen" style="">
            <div class="page pageCover">
                <div class="topTitleNav animate" data-compatibleQQBrowser data-style="background:url('/static/images/property_wechat_poster/title_nav_bg.png') 50% 100% no-repeat; background-size: 100% 100%;height:30vh;">
                    <div class="before" data-compatibleQQBrowser data-style="display:none;"></div>
                    <p class="title animate fixFontSize" data-maxHeight="5.5vh">{{property.get('name','')}}</p>
                    <p class="street animate fixFontSize" data-maxHeight="9vh">{{property.get('street','')}}</p>
                    <p class="city animate">{{property.get('city',{}).get('name','')}} {{(property.get('country',{}).get('code',''))}}</p>
                </div>
            </div>
            <div class="bottomBox animate">
                <div class="scrollUp"><i class="icon-up_arrow"></i></div>
            </div>
        </div>

        <div class="swiper-slide swiper-slide-bg commen" style="">
            <div class="page pageRental">
                <p class="line1 animate">{{_('售价')}}</p>

                <p class="line2 animate">
                    % if property.get('property_type') and (property.get('property_type').get('slug') == 'new_property' or property.get('property_type').get('slug') == 'student_housing') and 'main_house_types' in property and property.get('main_house_types') and len(property.get('main_house_types')):
                        % minPrice = property.get('main_house_types')[0].get('total_price_min')
                        %for index, type  in enumerate(property.get('main_house_types')):
                            %if int(float(minPrice.get('value'))) > int(float(type.get('total_price_min').get('value'))):
                            %   minPrice = type.get('total_price_min')
                            %end
                        %end
                    %string = """<span class="price_original" data-formatPrice>""" + minPrice.get('unit_symbol') + str(int(float(minPrice.get('value')))) + """</span><span class="sub">
                    """
                    {{!_('%s起') %string}}</span>
                        %if minPrice.get('localized_value',''):
                    <span class="price_reference" data-formatPrice>
                        {{_('约')}}
                        {{minPrice.get('localized_unit_symbol','')}}
                        {{int(float(minPrice.get('localized_value','')))}}
                    </span>
                        %end
                    % else :
                        %if 'total_price' in property and property.get('total_price'):
                    <span class="price_original" data-formatPrice>
                        {{property.get('total_price',{}).get('unit_symbol','')}}
                        {{int(float(property.get('total_price',{}).get('value','')))}}
                    </span>
                        %end
                        % if 'localized_unit_symbol' in property.get('total_price',{}) and property.get('total_price',{}).get('localized_unit_symbol','') != property.get('total_price',{}).get('unit_symbol',''):
                    <span class="price_reference" data-formatPrice>
                        {{_('约')}}
                        {{property.get('total_price',{}).get('localized_unit_symbol','')}}
                        {{int(float(property.get('total_price',{}).get('localized_value','')))}}
                    </span>
                        % end
                    % end
                </p>
                <ul class="itemBox clearfix">

                    <!-- todo 可能为空的字段的处理，总楼层的取值的处理-->

                    % if property.get('property_type') and (property.get('property_type').get('slug') == 'new_property' or property.get('property_type').get('slug') == 'student_housing') and 'main_house_types' in property and property.get('main_house_types') and len(property.get('main_house_types')):
                    % if len(property.get('main_house_types')) > 1:
                    <li class="animate rooms" style="width:45%;">
                        {{!format_property(property.get('main_house_types')[0])}}
                    </li>
                    <li class="animate rooms">
                        {{!format_property(property.get('main_house_types')[1])}}
                    </li>
                    % else:
                    <li class="animate rooms" style="width:100%;">
                        {{!format_property(property.get('main_house_types')[0])}}
                    </li>
                    <li class="animate rooms">
                    </li>
                    % end
                    % elif property.get('bedroom_count'):
                    <li class="animate rooms" style="width:100%;">
                        {{!format_property(property)}}
                    </li>
                    <li class="animate rooms">
                    </li>
                    % end

                    <li class="animate decorative_style"><div><i class="icon-art"></i><span>{{property.get('decorative_style',{}).get('value','')}}</span></div></li>
                    <li class="animate equity_type"><div><i class="icon-house"></i><span>{{property.get('equity_type',{}).get('value','')}}</span></div></li>

                    <li class="animate floor"><div><i class="icon-floor"></i><span>{{property.get('floor','暂无数据')}}</span></div></li>
                    <li class="animate building_type"><div><i class="icon-tag_icon"></i><span>{{property.get('building_type','')}}</span></div></li>

                    <li class="animate address">
                        <table>
                            <tr>
                                <td>
                                    <i class="icon-location"></i>
                                </td>
                                <td data-compatibleQQBrowser data-style="padding-left: 4.5vw;">
                                    %if property.get('community',''):
                                    {{property.get('community','')}},
                                    %end
                                    %if property.get('street',''):
                                    {{property.get('street','')}},
                                    %end
                                    {{property.get('city',{}).get('name','')}},
                                    {{get_country_name_by_code(property.get('country',{}).get('code',''))}},
                                    {{property.get('zipcode','')}}
                                </td>
                            </tr>
                        </table>
                    </li>
                </ul>
            </div>
            <div class="bottomBox animate">
                <div class="scrollUp"><i class="icon-up_arrow"></i></div>
            </div>
        </div>

        <div class="swiper-slide swiper-slide-bg commen
                % if property.get('description',''):
                show
                % else:
                hideInWechat
                % end
                " style="">
            <div class="page pageDescription">
                %if description:
                <h2 class="animate">"</h2>
                <p class="description animate">
                    {{property.get('description','')}}
                </p>
                <a class="btn btnModal animate viewMoreBtn" id="viewMoreBtn">
                    <i class="icon-down_arrow"></i>
                    <span>{{_('查看更多')}}</span>
                </a>
                <div class="linkBtnWrap animate">
                    <a href="/property/{{property.get('id','')}}" class="linkBtn">{{_('查看房产详尽资料')}}</a>
                </div>
                %else:
                <h2 class="animate hideInWechat">&nbsp;</h2>
                <p class="description animate hideInWechat">
                    {{_('暂无描述')}}
                </p>
                %end
            </div>
            <div class="bottomBox animate">
                <div class="scrollUp"><i class="icon-up_arrow"></i></div>
            </div>
        </div>

        %if property.get('highlight') and len(property.get('highlight')):
        <div class="swiper-slide swiper-slide-bg comen">
            <div class="page pageHighlight">
                <h2 class="animate">{{_('楼盘亮点')}}</h2>
                <ul class="highlight">
                    % for item in property.get('highlight'):
                    <li class="animate">{{item}}</li>
                    %end
                </ul>

            </div>
            <div class="bottomBox animate">
                <div class="scrollUp"><i class="icon-up_arrow"></i></div>
            </div>
        </div>
        %end

        <div class="swiper-slide swiper-slide-bg commen" style="">
            <div class="page pageMap">
                <!--<img id="mapImage" src="" alt=""/>-->
                <div class="mapImage" id="mapImage">
                    <div class="pushpin animate"></div>
                </div>
            </div>
            <div class="bottomBox mapBottom animate">
                <div class="location">
                    <h2><i class="icon-location"></i></h2>
                    <p>
                        {{property.get('floor','')}}
                        % if property.get('house_name') and property.get('floor'):
                        -
                        % end
                        {{property.get('house_name','')}}
                        % if property.get('house_name') or property.get('floor'):
                        ,
                        %end
                        % if property.get('community',''):
                        {{property.get('community','')}},
                        % end
                        % if property.get('street',''):
                        {{property.get('street','')}},
                        % end
                        {{property.get('city',{}).get('name','')}},
                        {{get_country_name_by_code(property.get('country',{}).get('code',''))}},
                        {{property.get('zipcode','')}}
                    </p>
                    <!--<p>湖北省武汉市光谷大道<br>国际企业中心</p>-->
                </div>
                <div class="scrollUp"><i class="icon-up_arrow"></i></div>
            </div>
        </div>

        <div class="swiper-slide swiper-slide-bg commen" style="">

            <div class="page pagePhoto swiper-container">
                <ul class="swiper-wrapper albumList">
                    % for name in ['reality_images','surroundings_images','floor_plan','effect_pictures',
                    % 'indoor_sample_room_picture','planning_map']:
                    % if property.get(name):
                    <li class="swiper-slide albumWrap">
                        <div class="swiper-container album">
                            <ul class="swiper-wrapper photoList" data-init="false">
                                % for image in property.get(name):
                                <li class="swiper-slide img" style="background-image: url('{{!fetch_image(image, property_id=property.get('id'))}}');">
                                </li>
                                % end
                            </ul>

                        </div>

                    </li>
                    % end
                    % end

                    % # Make sure property have videos and every video have at least one source
                    % if property.get('videos') and all(map(lambda x: "sources" in x and len(x["sources"]) > 0, property.get('videos'))):
                    <li class="swiper-slide video" id="videoContent">
                        <img src="/static/images/common/ajax-loader.gif" id="videoLoadIndicator" class="videoLoadIndicator"/>
                    </li>
                    % end
                </ul>
            </div>

            <div class="bottomBox photoBottom animate">
                <div class="photoThumbsBox">
                    <div class="photoThumbs swiper-container">
                        <ul class="swiper-wrapper thumbList">

                            % if property.get('reality_images', []) and len(property.get('reality_images', [])):
                            <li class="swiper-slide" data-tab="reality_images">
                                <span class="image" style="background-image: url({{!fetch_image(property.get('reality_images')[0], thumbnail=True, property_id=property.get('id'))}});"></span>
                                <span class="text_wrapper"> <span class="text">{{_('实景图')}}</span> </span>
                                <span class="border"></span>
                            </li>
                            % end

                            % if property.get('surroundings_images'):
                            <li class="swiper-slide" data-tab="surroundings_images">
                                <span class="image" style="background-image: url({{!fetch_image(property.get('surroundings_images')[0], thumbnail=True, property_id=property.get('id'))}});"></span>
                                <span class="text_wrapper"> <span class="text">{{_('设施图')}}</span> </span>
                                <span class="border"></span>
                            </li>
                            % end

                            % if property.get('floor_plan'):
                            <li class="swiper-slide" data-tab="floor_plan">
                                <span class="image" style="background-image: url({{!fetch_image(property.get('floor_plan')[0], thumbnail=True, property_id=property.get('id'))}});"></span>
                                <span class="text_wrapper"> <span class="text">{{_('户型图')}}</span> </span>
                                <span class="border"></span>
                            </li>
                            % end

                            % if property.get('effect_pictures'):
                            <li class="swiper-slide" data-tab="effect_pictures">
                                <span class="image" style="background-image: url({{!fetch_image(property.get('effect_pictures')[0], thumbnail=True, property_id=property.get('id'))}});"></span>
                                <span class="text_wrapper"> <span class="text">{{_('效果图')}}</span> </span>
                                <span class="border"></span>
                            </li>
                            % end

                            % if property.get('indoor_sample_room_picture'):
                            <li class="swiper-slide" data-tab="indoor_sample_room_picture">
                                <span class="image" style="background-image: url({{!fetch_image(property.get('indoor_sample_room_picture')[0], thumbnail=True, property_id=property.get('id'))}});"></span>
                                <span class="text_wrapper"> <span class="text">{{_('样板间图')}}</span> </span>
                                <span class="border"></span>
                            </li>
                            % end

                            % if property.get('planning_map'):
                            <li class="swiper-slide" data-tab="planning_map">
                                <span class="image" style="background-image: url({{!fetch_image(property.get('planning_map')[0], thumbnail=True, property_id=property.get('id'))}});"></span>
                                <span class="text_wrapper"> <span class="text">{{_('规划图')}}</span> </span>
                                <span class="border"></span>
                            </li>
                            % end

                            % if property.get('videos') and all(map(lambda x: len(x["sources"]) > 0, property.get('videos'))):
                            <li class="swiper-slide video">
                                <span class="image" style="background-image: url(/static/images/placeholder/video_holder_800x_141114.jpg)"></span>
                                <span class="text_wrapper"> <i class="icon-play"></i></span>
                                <span class="border"></span>
                            </li>
                            % end

                        </ul>
                    </div>
                    <div class="arrowButton prevButton" data-action="Prev"></div>
                    <div class="arrowButton nextButton" data-action="Next"></div>
                </div>

                <div class="scrollUp
                %if not report and not (property.get('estimated_monthly_cost') and property.get('estimated_monthly_rent')):
                hideOutsideWechat
                %end
                "><i class="icon-up_arrow"></i></div>
            </div>
        </div>

        <!--月收支分析-->
        %if property.get('estimated_monthly_cost') and property.get('estimated_monthly_rent'):
        <div class="swiper-slide swiper-slide-bg commen " style="">
            <div class="page pageIncome">
                <h2 class="animate">{{_('房产投资分析')}}</h2>
                % if property.get('property_type') and (property.get('property_type').get('slug') == 'new_property' or property.get('property_type').get('slug') == 'student_housing') and 'main_house_types' in property and property.get('main_house_types') and len(property.get('main_house_types')):
                % sample = property.get('main_house_types')[0]
                % minPrice = sample.get('total_price_min')

                %for index, type  in enumerate(property.get('main_house_types')):
                %if int(float(minPrice.get('value'))) > int(float(type.get('total_price_min').get('value'))):
                %   minPrice = type.get('total_price_min')
                %   sample = type
                %end
                %end

                % else :
                %if 'total_price' in property and property.get('total_price'):
                % sample = property
                %end
                % end
                <p class="description animate">
                    % if property.get('name'):
                    {{property.get('name','')}}{{_('投资分析')}}
                    % else:
                    {{_('基于该地区相似房产的投资分析')}}
                    % end
                    <br/>
                    {{_('以')}}
                    <span class="price_original" data-formatPrice>
                        {{sample.get('total_price',{}).get('unit_symbol')}}
                        {{int(float(sample.get('total_price',{}).get('value')))}}
                    </span>
                    {{_('为购入房价')}}
                </p>
                <p class="houseType animate">
                    {{_('参考户型')}}
                % if sample.get('bedroom_count') != 0:
                    {{sample.get('bedroom_count', 0)}}{{_('室')}}{{sample.get('living_room_count', 0)}}{{_('厅')}}
                % else:
                    studio
                % end
                </p>
                <ul>
                    <li class="animate">
                        <span class="key">{{_('房产价格：')}}</span>
                        <span class="value"><sub>{{sample.get('total_price',{}).get('unit_symbol')}}</sub><span data-formatPrice>{{int(float(sample.get('total_price',{}).get('value')))}}</span></span>
                    </li>
                    <li class="animate">
                        <span class="key">{{_('年租金回报：')}}</span>
                        <span class="value"><sub>{{property.get('estimated_monthly_rent',{}).get('unit_symbol','')}}</sub><span data-formatPrice>{{float(property.get('estimated_monthly_rent',{}).get('value','0'))*12}}</span></span>
                    </li>
                    % service_charge = 0
                    % for item in property.get('estimated_monthly_cost',[]):
                    % service_charge += float(item.get('price',{}).get('value','0')) * 12
                    % end
                    % net_earning = float(float(property.get('estimated_monthly_rent',{}).get('value','0'))) * 12 - service_charge
                    <li class="animate">
                        <span class="key">{{_('年管理费用&服务费：')}}</span>
                        <span class="value"><sub>{{item.get('price',{}).get('unit_symbol','')}}</sub>-<span data-formatPrice>{{service_charge}}</span></span>
                    </li>
                    <li class="bold animate">
                        <span class="key">{{_('年净租金回报：')}}</span>
                        <span class="value"><sub>{{property.get('estimated_monthly_rent',{}).get('unit_symbol','')}}</sub><span data-formatPrice>{{net_earning}}</span></span>
                    </li>
                    <li class="bold animate">
                        <span class="key">{{_('年净租金回报率：')}}</span>
                        <span class="value">{{round(net_earning/(float(sample.get('total_price',{}).get('value')))*100, 2)}}%</span>
                    </li>
                </ul>
            </div>
            <div class="bottomBox animate
            %if not report:
            hideOutsideWechat
            %end
            ">
                <div class="scrollUp"><i class="icon-up_arrow"></i></div>
            </div>
        </div>
        % end

        % if report:
        <div class="swiper-slide swiper-slide-bg commen " style="">
            <div class="page pageRegion">
                <h2 class="animate">{{_('街区报告：')}}<span>{{report.get('name','')}}</span></h2>
                <p class="description animate">
                    {{!report.get('description','')}}
                </p>
                <a class="btn siteLink animate linkBtn" href="/region-report/{{report.get('id','')}}">{{_('查看详尽街区报告')}}</a>
                <!--<p class="tag animate">-->
                <!-- todo -->
                <!--华人多, 学生多, 美食, 中国城-->
                <!--暂无内容-->
                <!--</p>-->
            </div>
            <div class="bottomBox animate hideOutsideWechat">
                <div class="scrollUp"><i class="icon-up_arrow"></i></div>
            </div>
        </div>
        % end

        <div class="swiper-slide swiper-slide-bg commen hideOutsideWechat" style="">
            <div class="page pageCoverBack">
                <div class="topTitleNav animate" data-compatibleQQBrowser data-style="background:url('/static/images/property_wechat_poster/title_nav_bg.png') 50% 100% no-repeat; background-size: 100% 100%;height:30vh;">
                    <div class="before" data-compatibleQQBrowser data-style="display:none;"></div>
                    <p class="title animate fixFontSize" data-maxHeight="5.5vh">{{property.get('name','')}}</p>
                    <p class="street animate fixFontSize" data-maxHeight="9vh">{{property.get('street','')}}</p>
                    <p class="city animate">{{property.get('city',{}).get('name','')}} {{(property.get('country',{}).get('code',''))}}</p>
                </div>
                <div class="moreProperytWrap animate" data-compatibleQQBrowser data-style="background:url('/static/images/property_wechat_poster/more_property_wrap_bg.png') 50% 0% no-repeat; background-size: 100% 100%;height:14vh;top:67.8vh;">
                    <div class="before" data-compatibleQQBrowser data-style="display:none;"></div>
                    <a class="animate" data-compatibleQQBrowser data-style="top:5vh;" href="/property-list?country={{property.get('country',{}).get('code','')}}&city={{property.get('city',{}).get('id','')}}"><span>{{_('更多精美房产')}}</span><i class="icon-enter"></i></a>
                    <div class="after" data-compatibleQQBrowser data-style="display:none;"></div>
                </div>
            </div>
            <div class="bottomBox coverBackBottom animate">

                <!--<div class="linkWrap clearfix">
                    <div class="siteLinkBox">
                        <a href="/app-download" class="btn siteLink">{{_('我也要发布')}}</a>
                    </div>
                    <div class="siteLinkBox">
                        &lt;!&ndash;todo 等城市API确定后，这里查看更多房源的链接改为查看对应城市的房源&ndash;&gt;
                        <a href="/property-list?country={{property.get('country',{}).get('code','')}}&city={{property.get('city',{}).get('id','')}}" class="btn siteLink">{{_('查看更多房产')}}</a>
                    </div>
                </div>-->
                <div class="copyright clearfix">
                    <div class="poweredBy">POWERED<br>BY</div>
                    <div class="logoBox">
                        <div class="logo"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<!--更多描述弹出层 start-->
<div class="descriptionMore hide modal" data-trigger="viewMoreBtn">
    <p>
        {{property.get('description','')}}
    </p>
    <a class="btn btnCloseModal viewMoreBtn animate" id="closeViewMoreBtn"><i class="icon-up_arrow2"></i><span>{{_('收起')}}</span></a>
</div>
<!--更多描述弹出层 end-->

<!-- @@include=/static/templates/property_video.tpl.html-->

<textarea id="pythonProperty" style="display: none;">
    {{json_dumps(property)}}
</textarea>

<!--@@close-->

<!--@@block =scripts -->
<!--build:js /static/scripts/property_wechat_poster.html.js-->
<script type="text/javascript" src="/static/scripts/property_wechat_poster.js"></script>
<!--endbuild-->

<script>
    (function () {
        if(!window.i18n){
            window.i18n = function (name) {
                var input = document.getElementById('i18n-str-' + name)
                if (!input) { return name }
                return input.value
            }
        }
        function initMapSrc(config){
            config.height = parseInt(config.width * $(window).height() / $(window).width())
            var baseSrc = 'https://dev.virtualearth.net/REST/v1/Imagery/Map/Road/{centerPoint}/{zoomLevel}?mapSize={width},{height}&mapLayer=TrafficFlow&format=jpeg&key={key}'
            if(config.centerPoint !== ',') {
                for(var k in config) {
                    baseSrc = baseSrc.replace('{' + k + '}', config[k])
                }
                $('.mapImage').css({
                    'background-image': 'url(' + baseSrc + ')'
                })
                $('.mapBottom').prepend('<div class="before"></div>').find('.before').css({
                    'background-image': 'url("data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20version%3D%221.1%22%20width%3D%221920%22%20height%3D%221120%22%3E%3Cdefs%3E%3Cfilter%20id%3D%22blur%22%3E%3CfeGaussianBlur%20stdDeviation%3D%225%22%2F%3E%3C%2Ffilter%3E%3C%2Fdefs%3E%3Cimage%20xlink%3Ahref%3D%22http%3A%2F%2Fplacekitten.com%2F1920%2F1120%22%20width%3D%221920%22%20height%3D%221120%22%20filter%3D%22url%28%23blur%29%22%2F%3E%3C%2Fsvg%3E"),url("' + baseSrc + '")'
                })
            } else {
                $('.mapImage').css({
                    'background': 'rgba(255,255,255,0.6)'
                }).find('.pushpin').addClass('noLocation').text(window.i18n('该房产暂无定位信息'))

            }
        }
        initMapSrc({
            key: 'AkJ0KjvTcgonnpDs-_UvgyhtiLhbugyjVGnAF811t5X-1TvKKQ2CAPwk8FuTRN_c',
            width: 600,
            centerPoint: '{{property.get("latitude","")}},{{property.get("longitude","")}}',
            zoomLevel: 14
        })

        /*
         * Weixin share sdk
         * */
        var wechatShareData = {
                title: '{{property.get('name','')}}',
                link: window.location.href,
                success:function(){
                    ga('send', 'event', 'wechat_poster', 'share', 'share-to-wechat-success')
                },
                cancel:function(){
                    ga('send', 'event', 'wechat_poster', 'share', 'share-to-wechat-cancel')
                }
            }

        % if property.get('reality_images'):
        wechatShareData.imgUrl = '{{property.get('reality_images')[0]}}' + '_thumbnail'
        %end

        % if description:
        wechatShareData.desc = '{{description}}'.replace(/(\r\n|\n|\r)/gm,'').slice(0,100)
        %end

        window.wechatShareSDK.init(wechatShareData)
    })()

</script>
<!--@@close-->

