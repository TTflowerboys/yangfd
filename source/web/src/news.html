<!--@@master=masters/master.html -->

<!--@@block = custom_header-->
<div class="newsHeader_phone  rmm" >
    <div class="rmm-toggled rmm-closed rmm-center-closed">
        <div class="rmm-toggled-controls">
            <div class="rmm-button">
                <i class="icon-switch_button"></i>
            </div>
            <div id="rmm-center-wrapper" class="rmm-center">
                <label id="newsHeader_title" class="title" for="">
                    %if 'title' in news:
                    {{news.get('title')}}
                    %end
                </label>
            </div>
            <div class="rmm-toggled-share">
                <img src="/static/images/property_details/phone/wechat_share.png" />
            </div>
        </div>
        <!-- @@include = partials/menu_items_mobile.html -->
    </div>
</div>

<!--@@close-->

<!--@@block=head -->
<!--build:css(dist) /static/styles/news.html.css-->
<link rel="stylesheet" href="/static/styles/news.css"/>
<link rel="stylesheet" href="/static/styles/phone/wechatSharePopup.css"/>
<!--endbuild-->

<!--@@close-->

<!--@@block=main -->
%if news:
    <textarea id="newsData" style="display:none;">{{json_dumps(news_clean)}}</textarea>
    <div class="container">
        %if 'title' in news:
            <h1 class="title">{{news.get('title')}}</h1>
        %end

        <div class="button-group">
            %if 'time' in news:
                <label class="date" for=""> <i class="hint" data-utc-time="{{news.get('time')}}"></i></label>
            %end

            %for cate in news.get('category',{}):
                %if cate.get('slug') == 'announcement':
                    <label class="category" for=""> | <a href="/notice-list">{{cate.get('value','')}}</a></label></label>
                %elif cate.get('slug') == 'legal_resource':
                    <label class="category" for=""> | <a href="/laws">{{cate.get('value','')}}</a></label></label>
                %elif cate.get('slug') == 'purchase_process':
                    <label class="category" for=""> | <a href="/guides">{{cate.get('value','')}}</a></label></label>
                %else :
                    <label class="category" for=""> | <a href="/news-list">{{_('房产资讯')}}</a></label></label>
                %end
            %end

            %if 'link' in news :
                <label class="source" for=""> <i class="hint">{{_('来源：')}}</i>
                    <a href={{news.get('link')}}>{{_('原文地址')}}</a></label>
            %end

            <div class="share">
                <a data-fn="shareToFacebook" class="shareButton">
                    <i class="icon-facebook"></i>
                </a>
                <a data-fn="shareToTwitter" class="shareButton">
                    <i class="icon-twitter"></i>
                </a>                
                <a data-fn="shareToLinkedin" class="shareButton">
                    <i class="icon-linkedin2"></i>
                </a>
                <a data-fn="shareToWeChat" class="shareButton">
                    <i class="icon-wechat"></i>
                </a>
                <a data-fn="shareToWeibo" class="shareButton">
                    <i class="icon-weibo"></i>
                </a>
            </div>
        </div>
        <div class="content">
            %if ('images' in news) and news.get('images'):
                <img alt="{{news.get('title',_('洋房东'))}}" src="{{!fetch_image(news.get('images')[0], news_id=news.get('id'))}}"/>
            %end
            %if 'content' in news:
                <div class="fullText">
                    {{!news.get('content')}}
                </div>
            %end

            %for cate in news.get('category',{}):
                %if cate.get('slug') == 'purchase_process':
                <div class="propertyListEntry">
                    <a class="ghostButton red" href="/property-list">
                        {{_('了解了?开始选房!')}}
                    </a>
                </div>
                %end
            %end
        </div>

        %if ('related_news_list' in vars() and related_news_list):
            <div class="relatedNews">
                <h2 class="title">
                    {{_('相关新闻')}}
                </h2>
                <ul>
                     % for news_item in related_news_list:
                         <li class="newsItem">
                             <a href="/news/{{news_item.get('id')}}">
                                 %if news_item.get('images'):
                                     <img src="{{!fetch_image(news_item.get('images')[0], thumbnail=True, news_id=news_item.get('id'))}}" onerror="window.onImgError(this);"/>
                                 %end
                                 <div class="img_shadow"></div>
                                 <h3 class="title">
                                         {{news_item.get('title')}}
                                 </h3>
                             </a>
                         </li>
                     % end
                 </ul>
            </div>
        %end
    </div>
%end

<div class="wechatPage_popup" style="display:none;">
    <h1 class="tip"> {{!_('点击右上角')}}</h1>
    <img class="buttonHolder"  alt="" src="/static/images/property_details/wechat_share/phone/wechat_button.png"/>
    <h1 class="tip"> {{!_('分享链接给微信好友')}}</h1>
    <div class="guide">
        <img  alt="" src="/static/images/property_details/wechat_share/phone/wechat_guide.png"/>
    </div>
    <a class="gotIt" href ="#close-modal" rel="modal:close">{{_('我知道了')}}</a>
</div>

<div id="popupShareToWeChat" style="display:none; text-align:center;font-size: 12px;">
    <img src="" alt="二维码" width="220" height="220"/>
    <p>{{_('打开微信，使用 “扫一扫” 即可将网页分享到朋友圈')}}</p>
</div>

<!--@@close-->

<!--@@block=scripts -->
<!--build:js /static/scripts/news.html.js-->
<!--endbuild-->
<script>
    (function () {

        $('.rmm-toggled .rmm-toggled-controls .rmm-toggled-share').on('click', function () {
            window.openNewsWeChatShare('{{news.get('id')}}')
            ga('send', 'event', 'news', 'share', 'open-wechat-mobile')
        });

        window.openNewsWeChatShare = function (newsId) {
            if (window.team.isWeChat()) {
                if (window.team.isWeChatiOS()) {
                    $('.wechatPage_popup .buttonHolder').attr('src', '/static/images/property_details/wechat_share/phone/wechat_button_ios.png')
                }
                $('.wechatPage_popup').modal()
                $('.wechatPage_popup').find('.close-modal').hide()
            }
            else {
                window.location.href = "/wechat_share?news=" + newsId
            }
        }


        $('[data-fn=shareToWeChat]').on('click', function () {
            $('#popupShareToWeChat')
                .find('img').prop('src', '/qrcode/generate?content=' + encodeURIComponent(window.location.href)).end()
                .modal()
            ga('send', 'event', 'news', 'share', 'open-wechat')
        })

        $('[data-fn=shareToWeibo]').on('click', function () {
            var news = JSON.parse($('#newsData').text())
            var params = {'title': news.title, 'url': window.location.href}
            if (news.images && news.images.length > 0) {
                params.pic = news.images[0]
            }
            team.shareToWeibo(params)
            ga('send', 'event', 'news', 'share', 'open-weibo')
        })
        $('[data-fn=shareToTwitter]').on('click', function () {
            var news = JSON.parse($('#newsData').text())
            var params = {'text': news.title, 'url': window.location.href}
            if (news.images && news.images.length > 0) {
                params.pic = news.images[0]
            }
            team.shareToTwitter(params)
            ga('send', 'event', 'news', 'share', 'open-twitter')
        })
        $('[data-fn=shareToLinkedin]').on('click', function () {
            var news = JSON.parse($('#newsData').text())
            var params = {'text': news.title, 'url': window.location.href}
            if (news.images && news.images.length > 0) {
                params.pic = news.images[0]
            }
            team.shareToLinkedin(params)
            ga('send', 'event', 'news', 'share', 'open-linkedin')
        })


        var news = JSON.parse($('#newsData').text())

        var newsImage = null
        if (news.images && news.images.length>0) {
            newsImage = news.images[0] + '_thumbnail'
        }else {
            //Set logo as default
            newsImage = '/static/images/logo/logo_wechat.jpg'
        }
        var wechatShareData = {
            title:news.title,
            link: window.location.href,
            imgUrl:newsImage,
            success:function(){
                ga('send', 'event', 'news', 'share', 'share-to-wechat-success')
            },
            cancel:function(){
                ga('send', 'event', 'news', 'share', 'share-to-wechat-cancel')
            }
        }

        if (news.summary) {
            wechatShareData.desc = news.summary.replace(/(\r\n|\n|\r)/gm,'').slice(0, 100)
        }
        window.wechatShareSDK.init(wechatShareData)
    })()


     /*
      * Facebook share sdk
      * */
    
    $(function(){
        $.ajaxSetup({ cache: true });
        $.getScript('//connect.facebook.net/en_US/sdk.js', function(){
            FB.init({
                appId: '325899391113500',
                xfbml      : true,
                version: 'v2.8'
            });
            $('[data-fn=shareToFacebook]').on('click',function(){
                FB.ui({
                    method: 'share',
                    display: 'popup',
                    href: window.location.href
                });
            })
        })
    });


</script>

<!--@@close-->

