<style>
    .guideLine {
        width: 100%;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 106;
        background: rgba(0,0,0,0.75);
    }
    .guideLine p{
        width: 180px;
        margin: 20px auto;
        line-height: 1.4em;
        color: #fff;
        font-size: 18px;
    }
    .guideLine i.arrow{
        display: block;
        position: absolute;
        right: 21px;
        top: 6px;
        width: 52px;
        height: 40px;
        background: url("/static/images/app_download/guide_arrow.png");
        background-size: contain;
        background-repeat: no-repeat;
    }
</style>
<!--微信签名 start-->
<textarea id="pythonWeixin" style="display: none;">
    {{json_dumps(weixin)}}
</textarea>
<!--微信签名 end-->
<div class="guideLine" style="display: none;">
    <p>{{_('点击后在弹出的菜单中选择 [分享到朋友圈]')}}</p>
    <i class="arrow"></i>
</div>
<script>
(function () {
    /*
     * Weixin share sdk
     * */
    $(function () {
        //http://stackoverflow.com/questions/9413737/how-to-append-script-script-in-javascript
        $('body').append('<script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"><\/script>')
        initWechatSDK()
    })
    window.wechatShareSDK = window.wechatShareSDK || {}
    var weixin = $('#pythonWeixin').text()
    if(weixin && weixin !== 'null' && weixin !== 'none' && weixin !== ''){
        weixin = JSON.parse(weixin)
    }
    /**
    * 弹出遮罩层提示点击屏幕右上方进行分享操作
    * */
    window.wechatShareSDK.showGuideLine = function showGuideLine (text) {
        text = text || i18n('点击后在弹出的菜单中选择 [分享到朋友圈]')
        $('.guideLine p').text(text)
        $('.guideLine').fadeIn(300).off('click').on('click', function () {
            $(this).fadeOut(300)
        })
    }

    /**
     * 会调用 init 进行初始化，并且弹出遮罩层提示点击屏幕右上方进行分享操作，当微信SDK尚未初始化完成时，会先将需要分享的内容存入到一个 queue ，初始化完成后再进行分享
     * */
    window.wechatShareSDK.init = window.wechatShareSDK.init || function (option, callbackObj) {
        window.wechatShareSDK.initQueue = window.wechatShareSDK.initQueue || []
        window.wechatShareSDK.initQueue.push({
            option: option,
            callbackObj: callbackObj
        })
    }
    window.wechatShareSDK.setUp = window.wechatShareSDK.setUp || function (option, callbackObj) {
        window.wechatShareSDK.setUpQueue = window.wechatShareSDK.setUpQueue || []
        window.wechatShareSDK.setUpQueue.push({
            option: option,
            callbackObj: callbackObj
        })
    }
    var timer
    function initWechatSDK() {
        if (typeof window.wx !== 'undefined' && typeof weixin === 'object') {
            clearTimeout(timer)
            window.wx.config({
                debug: window.wxSDKDebug || false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                appId: 'wx123992a4d173037b', // 必填，公众号的唯一标识
                timestamp: weixin.timestamp, // 必填，生成签名的时间戳
                nonceStr: weixin.noncestr, // 必填，生成签名的随机串
                signature: weixin.signature,// 必填，签名，见附录1
                jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'onMenuShareQQ'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
            })
            window.wx.ready(function(){
                /**
                 * 初始化微信分享SDK
                 *
                 * @param {Object} option - 微信分享的参数
                 * @param {string} option.title - 分享标题，默认为当前页面的标题
                 * @param {string} option.desc - 分享文字描述，默认为server端传入页面的 description 清除HTML标签和换行后，取前100个字符
                 * @param {string} option.link - 分享链接，默认为当前页面的url
                 * @param {string} option.imgUrl - 分享缩略图，默认为 http://upload.yangfd.com/app_icon_x120_150427.png
                 * @param {function} option.success - 用户分享成功的回调函数
                 * @param {function} option.cancel - 用户取消分享的回调函数
                 *
                 * @param {Object} callbackObj - 可选的单独的分享回调函数设置
                 * @param {Object} callbackObj.timeline - 单独设置分享到朋友圈的回调函数
                 * @param {function} callbackObj.timeline.success - 分享到朋友圈成功的回调函数
                 * @param {function} callbackObj.timeline.cancel - 用户取消分享到朋友圈的回调函数
                 * @param {Object} callbackObj.appMessage - 单独设置分享给微信好友的回调函数
                 * @param {function} callbackObj.appMessage.success - 分享给微信好友成功的回调函数
                 * @param {function} callbackObj.appMessage.cancel - 用户取消分享给微信好友的回调函数
                 * @param {Object} callbackObj.qq - 单独设置分享给QQ好友的回调函数
                 * @param {function} callbackObj.qq.success - 分享给QQ好友成功的回调函数
                 * @param {function} callbackObj.qq.cancel - 用户取消分享给QQ好友的回调函数
                * */
                window.wechatShareSDK.init = function (option, callbackObj) {
                    callbackObj = callbackObj || {}
                    var defaultWechatShareData = {
                        title: '{{title}}',
                        desc: '{{clear_line_break(clear_html_tags(description))}}'.slice(0, 100),
                        link: window.location.href,
                        imgUrl: 'https://upload.yangfd.com/app_icon_x120_150427.png',
                        success:function(){

                        },
                        cancel:function(){

                        }
                    }
                    var wechatShareData = _.extend(_.clone(defaultWechatShareData), option)
                    if(window.team.isWeChat()) {
                        wechatShareData.imgUrl = wechatShareData.imgUrl.replace("upload.yangfd.com/", "yangfd.com/s3_raw/").replace("bbt-currant.s3.amazonaws.com/", "yangfd.com/s3_raw/")
                    }

                    var timelineWechatShareData = _.extend(_.clone(wechatShareData), (callbackObj ? callbackObj.timeline : {}))
                    var appMessageWechatShareData = _.extend(_.clone(wechatShareData), (callbackObj ? callbackObj.appMessage : {}))
                    var qqWechatShareData = _.extend(_.clone(wechatShareData), (callbackObj ? callbackObj.qq : {}))

                    window.wx.onMenuShareTimeline(timelineWechatShareData);
                    window.wx.onMenuShareAppMessage(appMessageWechatShareData);
                    window.wx.onMenuShareQQ(qqWechatShareData);
                }
                window.wechatShareSDK.setUp = function (option, callbackObj) {
                    window.wechatShareSDK.init(option, callbackObj)
                    window.wechatShareSDK.showGuideLine()
                }
                while(window.wechatShareSDK.initQueue && window.wechatShareSDK.initQueue.length) {
                    window.wechatShareSDK.init(window.wechatShareSDK.initQueue[0].option, window.wechatShareSDK.initQueue[0].callbackObj)
                    window.wechatShareSDK.initQueue.shift()
                }
                while(window.wechatShareSDK.setUpQueue && window.wechatShareSDK.setUpQueue.length) {
                    window.wechatShareSDK.setUp(window.wechatShareSDK.setUpQueue[0].option, window.wechatShareSDK.setUpQueue[0].callbackObj)
                    window.wechatShareSDK.setUpQueue.shift()
                }
            })
            window.wx.error(function(res){
                ga('send', 'event', window.location.pathname, 'share', 'share-to-wechat-config-error', res.errMsg)
            })
        } else {
            timer = setTimeout(initWechatSDK, 50)
        }
    }
})()
</script>
