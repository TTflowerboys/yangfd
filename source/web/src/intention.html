<!--@@master = masters/big_picture_bg_master.html-->

<!--@@block = head-->
<!--build:css(dist) /static/styles/intention.html.css-->
<link rel="stylesheet" href="/static/styles/intentionPage.css"/>
<link rel="stylesheet" href="/static/styles/project/processCard.css"/>
<!--endbuild-->
<!--@@close-->

<!--@@block = main-->
<form class="box intentionPage" name="intentionForm">
    <div class="header">
        <h1>{{_('还差最后一步就可以看到为您推荐的投资机会了！')}}</h1>
        <div class="action">
            <a href="/">{{_('跳过')}}</a>
            <button type="submit" disabled>{{_('确定')}}</button>
        </div>
        <a class="skip_phone ghostButton" href="/">{{_('跳过')}}</a>
    </div>
    <hr/>
    <div class="row budget">
        <label class="budget">{{_('您的预算')}}
            (
            <!--@@include=partials/current_currency.html -->
            ):&nbsp;</label>
            <div class="controls">
                %for index, budget in enumerate(budget_list):
                    %if budget.get('currency') == _.currency:
                        <label class="toggleTag"><input name="budget" type="radio" value="{{budget.get('id')}}"/>{{budget.get('value')}}</label>
                    %end
                %end
            </div>
    </div>
    <!-- @@include=partials/intention_tabs.html -->

    <button class="submit_phone"  type="submit" disabled>{{_('确定')}}</button>

</form>
<!--@@close-->
<!--@@block = scripts-->
<script>
 (function () {

     $('[data-tabs]').tabs({trigger: 'hover'})

     var $intentionform = $('form[name=intentionForm]')

     $intentionform.find('[name=budget]').on('change', function () {
         $(this).parent().toggleClass('selected', this.checked)
                .siblings().removeClass('selected')
         ga('send', 'event', 'intention-selection', 'change', 'change-budget',$(this).parent().text())
     })

     $intentionform.find('[name=intention]').on('change', function () {
         $(this).closest('li').toggleClass('selected', this.checked)
         ga('send', 'event', 'intention-selection', 'change', 'change-intention',$(this).parent().text().replace(/ /g,'').replace(/(\r\n|\n|\r)/gm,''))
     })

     $intentionform.find('[name]').on('change', function () {
         var data = $intentionform.serializeObject()
         $intentionform.find('[type=submit]').prop('disabled', _.isEmpty(data))
     })

     $intentionform.submit(function (e) {
         e.preventDefault()
         ga('send', 'event', 'intention-selection', 'click', 'intention-submit')

         var data = $(this).serializeObject()

         var intentionTags = $(this).find('.intention .controls').children('.selected')
         var intention = ''
         _.each(intentionTags, function (item) {
             intention =  intention + $(item).attr('data-id') + ','
         })

         if (intention) {
             if (_.last(intention) === ',') {
                 intention = intention.substring(0, intention.length - 1)
             }
             data.intention = intention
         }

         if (!data.budget && !data.intention) { location.href = '/';  return;}
         $intentionform.find('[type=submit]').css({cursor: 'wait'})
         $.betterPost('/api/1/user/edit', data)
             .done(function(){
                 location.href = '/'
                 ga('send', 'event', 'intention-selection', 'result', 'intention-submit-success')
             })
             .fail(function(errorCode){
                 ga('send', 'event', 'intention-submit', 'result', 'intention-submit-failed',errorCode)
             })
             .always(function () {
                 $intentionform.find('[type=submit]').css({cursor: 'default'})
            })
     })

     function skipIntention(){
         location.href = '/'
         ga('send', 'event', 'intention-selection', 'click', 'skip-intention-selection')
     }
 })()
</script>
<!--@@close-->
