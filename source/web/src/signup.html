<!--@@master=masters/signin_master.html -->

<!--@@block=head -->
<!--build:css(dist) /static/styles/project/signup.html.css-->
<link rel="stylesheet" href="/static/styles/project/registerForm.css"/>
<link href="/static/styles/recaptcha.css" rel="stylesheet"/>
<!--endbuild-->
<!--@@close-->

<!--@@block=main -->
<!-- @@include =partials/register_form.html -->
<!--@@close-->

<!--@@block=scripts -->
<script type="text/javascript" src="/static/vendors/recaptcha_ajax.js"></script>
<script>
    function showRecaptcha(containerId) {
        Recaptcha.create("6LdOPfwSAAAAALlc4POi3YiUJmKe_rUw6-xO6NsN", containerId,
            {theme: "white", callback: Recaptcha.focus_response_field});
    }

    function getRecaptchaChallenge() {
        return  Recaptcha.get_challenge()
    }

    function getRecaptchaResponse() {
        return  Recaptcha.get_response()
    }

    $(function () {
        showRecaptcha('recaptcha_div')
        var errorArea = $('form[name=register]').find('.errorMessage')
        $('form[name=register]').submit(function (e) {
            e.preventDefault()
            errorArea.hide()

            var valid = $.validate(this, {onError: function (dom, validator, index) {
                errorArea.text(window.getErrorMessage(dom.name, validator))
                errorArea.show()
            }})

            if (!valid) {
                return
            }

            var params = $(this).serializeObject()
            params.password = Base64.encode(params.password)
            params['challenge'] = getRecaptchaChallenge()
            params['solution'] = getRecaptchaResponse()
            $.betterPost("/api/1/user/register", params)
                .done(function () {
                    project.goToIntention()
                }).fail(function () {
                    errorArea.text(window.i18n('注册失败'))
                    errorArea.show()
                }).always(function () {
                    //refresh it for may user submit fail, or submit again with another account
                    showRecaptcha()
                })
        })
    })


</script>
<!--@@close-->
