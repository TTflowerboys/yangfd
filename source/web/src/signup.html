<!--@@master=masters/signin_master.html -->

<!--@@block=head -->
<link rel="stylesheet" href="/static/styles/project/registerForm.css"/>
<!--@@close-->

<!--@@block=main -->
<!-- @@include =partials/register_form.html -->
<!--@@close-->

<!--@@block=scripts -->
<script type="text/javascript" src="/static/vendors/recaptcha_ajax.js"></script>
<script>
    function showRecaptcha() {
        Recaptcha.create("6LfNfvkSAAAAACXjRTaEqvN-aLyG6w5Swp2kh9yz", "recaptcha_div",
            {theme: "white", callback: Recaptcha.focus_response_field});
    }
    $(function () {
        showRecaptcha()
        var errorArea = $('form[name=register]').find('.errorMessage')
        $('form[name=register]').submit(function (e) {
            e.preventDefault()
            errorArea.hide()

            var valid = $.validate(this, {onError: function (dom, validator, index) {
                errorArea.text(window.getErrorMessage(dom.name, validator))
                errorArea.show()
            }})

            if (!valid) {
                return
            }

            var params = $(this).serializeObject()
            params.password = Base64.encode(params.password)
            params['challenge'] = Recaptcha.get_challenge()
            params['solution'] = Recaptcha.get_response()
            $.post("/api/1/user/register",
                params,
                function (data, status) {
                    if (data.ret != 0) {
                        errorArea.text(window.i18n('注册失败'))
                        errorArea.show()
                    }
                    else {
                        project.goBackFromURL()
                    }
                    //refresh it for may user submit fail, or submit again with another account
                    showRecaptcha()
                });
        })
    })


</script>
<!--@@close-->
