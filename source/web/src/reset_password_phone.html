<!--@@master=masters/signin_master.html -->

<!--@@block=head -->
<!--build:css(dist) /static/styles/project/resetPasswordForm.html.css-->
<link rel="stylesheet" href="/static/styles/project/resetPasswordForm.css"/>
<!--endbuild-->
<!--@@close-->

<!--@@block=main -->
<form name="resetPassword" class="resetPasswordForm" autocomplete="off">
    <div id="step1" class="form bordered">
        <!-- @@include= partials/phone_row.html -->       
    </div>     
    <button type="button" id="voiceVerification" class="voiceVerification button red">{{_('通过语音验证')}}</button>
    <p id="voiceHint" class="voiceHint" style="display:none"></p>
    <div id="step2" class="form bordered" style="display:none">
        <div class="form_row">
            <span class="iconWrap">
                <img src="/static/images/signin/lock.png" alt=""/>
            </span>
            <input name="password" type="password" placeholder={{_('设置新密码')}} size=20
                data-validator="required" data-error-required="请设置新密码">
        </div>
        <hr>
        <div class="form_row">
            <span class="iconWrap">
                <img src="/static/images/signin/sms.png" alt=""/>
            </span>
            <input name="new_password" type="password" placeholder={{_('确认新密码')}} size=20
                data-validator="required, sameAs(password)" data-error-required="请确认新密码" data-error-sameAs="新密码和确认密码输入不一致">
        </div>
    </div>
    <p class="errorMessage" style="display:none"></p>
    <button type="submit" class="signin button red" style="display:none">{{_('提交')}}</button>
</form>
<!--@@close-->

<!--@@block=scripts -->
<script>
    (function () {

        var $form = $("form[name=resetPassword]")
        var errorArea = $form.find('.errorMessage')
        var userId = ""

        function startVerificationTimer() {
            $form.find('#voiceVerification').hide()
            $form.find('#voiceHint').show()
            var sec = 60
            var timer = setInterval(function(){
                if(sec == 0){
                    $form.find('#voiceHint').html(window.i18n('请按照语音提示操作（默认按手机键盘上数字1即可验证成功），如果没有接到联系电话，请') +  window.i18n('<a id="voiceVerification" class="voiceVerification">重试</a>'))
                    $form.find('#voiceHint #voiceVerification').click(sendVoiceVerification)
                    clearInterval(timer)
                }
                else {
                    $form.find('#voiceHint').text(window.i18n('请按照语音提示操作（默认按手机键盘上数字1即可验证成功），如果没有接到联系电话，请') + sec + window.i18n('s 后重试'))
                    sec--
                }
            },1000)
        }

        function sendVoiceVerification() {
            var phone = $form.find('[name=phone]').val()
            if (phone) {
                $form.find('.phoneIndicator').show();
                errorArea.text(window.i18n('发送中...'))
                errorArea.show()

                var params = $form.serializeObject()
                var theParams = {}
                theParams['phone'] = '+' + params.country_code + params.phone
                theParams['verify_method'] = 'call'
                $.betterPost("/api/1/user/sms_verification/send", theParams)
                    .done(function (val) {
                        userId = val
                        errorArea.text(window.i18n('发送成功'))
                        startVerificationTimer()
                        startCheckVoiceVerfication()
                    })
                    .fail(function (ret) {
                        errorArea.text(window.getErrorMessageFromErrorCode(ret))
                    })
                    .always(function () {
                        $form.find('.phoneIndicator').hide();
                    })
            }
            else {
                errorArea.text(window.i18n('手机不能为空'))
                errorArea.show()
            }
        }

        $form.find('#voiceVerification').click(sendVoiceVerification)


        var xhr = null
        function startCheckVoiceVerfication() {
            var params = $form.serializeObject()
            var phone = '+' + params.country_code + params.phone.trim()


            //abort request when user retry the verification
            if (xhr && xhr.readyState !== 4) {
                xhr.abort()
            }
            xhr = $.get('/api/1/user/sms_verfication/sinch_call_check', {phone: phone}).success(
                function (data) {
                    if (data.ret === 0) {

                        errorArea.text(window.i18n('验证成功'))
                        //show after hint
                        $form.find('#step2').show()
                        $form.find('button[type=submit]').show()
                    } else {

                        startCheckVoiceVerfication()
                    }
                }).fail(function (xhr) {
                    if (xhr.statusText !== 'abort') {
                        startCheckVoiceVerfication()
                    }
                })

        }


        $form.submit(function (e) {
            e.preventDefault()
            errorArea.hide()
            if (!userId) {
                errorArea.text(window.i18n('请点击“获取验证码”'))
                errorArea.show()
                return
            }

            var valid = $.validate(this, {
                onError: function (dom, validator, index) {
                    errorArea
                        .text(dom.getAttribute('data-error-' + validator) || window.getErrorMessage(dom.name,
                            validator))
                        .show()
                }
            })

            if (!valid) {return}


            var params = $form.serializeObject()            
            delete params.country_code
            delete params.phone
            delete params.password
            params.new_password = Base64.encode(params.new_password)
            params.verify_method = 'call'
            params.code = "call"//just a random string is also ok.

            $.betterPost("/api/1/user/" + userId + "/sms_reset_password", params)
                .done(function (val) {
                    project.goBackFromURL()
                })
                .fail(function (ret) {
                    errorArea.text(window.getErrorMessageFromErrorCode(ret))
                    errorArea.show()
                })
        })
    })()
</script>
<!--@@close-->
