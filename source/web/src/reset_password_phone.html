<!--@@master=masters/signin_master.html -->

<!--@@block=head -->
<!--build:css(dist) /static/styles/project/resetPasswordForm.html.css-->
<link rel="stylesheet" href="/static/styles/project/resetPasswordForm.css"/>
<!--endbuild-->
<!--@@close-->

<!--@@block=main -->
<form name="resetPassword" class="resetPasswordForm" autocomplete="off">
    <div class="form bordered">
        <!-- @@include= partials/phone_row.html -->
        <hr>
        <div class="code form_row">
            <span class="iconWrap">
                <img src="/static/images/signin/sms.png" alt=""/>
            </span>
            <input name="code" placeholder={{_('短信验证码')}} size=10
                data-validator="required, trim" data-error-required="请填写短信验证码">
            <a id="smsVerificationSend" href=# style="position:absolute; right:0;font-size:12px; color:#aaa;">{{_('获取验证码')}}</a>
        </div>
        <hr>
        <div class="form_row">
            <span class="iconWrap">
                <img src="/static/images/signin/lock.png" alt=""/>
            </span>
            <input name="password" type="password" placeholder={{_('设置新密码')}} size=20
                data-validator="required" data-error-required="请设置新密码">
        </div>
        <hr>
        <div class="form_row">
            <span class="iconWrap">
                <img src="/static/images/signin/sms.png" alt=""/>
            </span>
            <input name="new_password" type="password" placeholder={{_('确认新密码')}} size=20
                data-validator="required, sameAs(password)" data-error-required="请确认新密码" data-error-sameAs="密码不一致">
        </div>
    </div>
    <p class="errorMessage" style="display:none"></p>
    <button type="submit" class="signin button red">{{_('提交')}}</button>
</form>
<!--@@close-->

<!--@@block=scripts -->
<script>
    (function () {

        var $form = $("form[name=resetPassword]")
        var errorArea = $form.find('.errorMessage')
        var userId = ""


        $form.find('#smsVerificationSend').click(function () {
            var phone = $form.find('[name=phone]').val()
            if (phone) {
                $form.find('.phoneIndicator').show();
                errorArea.text(window.i18n('发送中...'))
                errorArea.show()

                var params = $form.serializeObject()
                var theParams = {}
                theParams['phone'] = '+' + params.country_code + params.phone
                $.betterPost("/api/1/user/sms_verification/send", theParams)
                    .done(function (val) {
                        userId = val
                        errorArea.text(window.i18n('发送成功'))

                    })
                    .fail(function () {

                        errorArea.text(window.i18n('发送失败，请重试'))

                    })
                    .always(function () {
                        $form.find('.phoneIndicator').hide();
                    })
            }
            else {
                errorArea.text(window.i18n('手机不能为空'))
                errorArea.show()
            }
        })

        $form.submit(function (e) {
            e.preventDefault()
            errorArea.hide()
            if (!userId) {
                errorArea.text(window.i18n('请点击“获取验证码”'))
                errorArea.show()
                return
            }

            var valid = $.validate(this, {
                onError: function (dom, validator, index) {
                    errorArea
                        .text(dom.getAttribute('data-error-' + validator) || window.getErrorMessage(dom.name,
                            validator))
                        .show()
                }
            })

            if (!valid) {return}


            var params = $form.serializeObject()
            params.phone = '+' + params.country_code + params.phone
            delete params.country_code
            params.new_password = Base64.encode(params.new_password)

            $.betterPost("/api/1/user/" + userId + "/sms_reset_password", params)
                .done(function (val) {
                    project.goBackFromURL()
                })
                .fail(function () {
                    errorArea.text(window.i18n('重置密码失败'))
                    errorArea.show()
                })
        })
    })()
</script>
<!--@@close-->
